# ========================================
# ENVIRONMENT VARIABLES
# ========================================

set-environment -g TMUX_PLUGIN_MANAGER_PATH "$XDG_DATA_HOME/tmux/plugins/"

# ========================================
# PLUGINS
# ========================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'mrjones2014/smart-splits.nvim'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-online-status'
set -g @plugin 'junkaizhang8/tmux-battery'

# ========================================
# PLUGIN OPTIONS
# ========================================

# smart-splits.nvim
set -g @smart-splits_no_wrap '' # to disable wrapping. (any value disables wrapping)

set -g @smart-splits_move_left_key  'C-h' # key-mapping for navigation.
set -g @smart-splits_move_down_key  'C-j' #  --"--
set -g @smart-splits_move_up_key    'C-k' #  --"--
set -g @smart-splits_move_right_key 'C-l' #  --"--

set -g @smart-splits_resize_left_key  'C-M-h' # key-mapping for resizing.
set -g @smart-splits_resize_down_key  'C-M-j' #  --"--
set -g @smart-splits_resize_up_key    'C-M-k' #  --"--
set -g @smart-splits_resize_right_key 'C-M-l' #  --"--

set -g @smart-splits_resize_step_size '3' # change the step-size for resizing.

# resurrect and continuum
set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-restore 'on'

# tmux-online-status
set -g @online_icon "ok"
set -g @offline_icon "nok"

# ========================================
# STATUS BAR OPTIONS
# ========================================

# Theme is heavily inspired by:
# https://github.com/naivecynics/primary-tmux
# which is based on the setup in this discussion:
# https://github.com/catppuccin/tmux/discussions/317#discussioncomment-11064512

# Config color scheme
if-shell '[ -f "$XDG_CONFIG_HOME/tmux/colors.conf" ]' 'source-file "$XDG_CONFIG_HOME/tmux/colors.conf"'

# Status left look and feel
set -g status-left-length 100
set -g status-left ""
set -ga status-left "#{?client_prefix,#{#[bg=#{@thm_red},fg=default,bold]  #S },#{#[bg=default,fg=#{@thm_red},bold]  #S }}"
set -ga status-left "#[bg=default,fg=#{@thm_overlay0},none,bold]│"
set -ga status-left "#[bg=default,fg=#{@thm_green},bold]  #{pane_current_command} "
set -ga status-left "#[bg=default,fg=#{@thm_overlay0},none,bold]│"
set -ga status-left "#[bg=default,fg=#{@thm_blue},bold]  #{=/-20/...:#{s|$USER|~|:#{b:pane_current_path}}} "
set -ga status-left "#[bg=default,fg=#{@thm_overlay0},none,bold]#{?window_zoomed_flag,│,}"
set -ga status-left "#[bg=default,fg=#{@thm_yellow},bold]#{?window_zoomed_flag,  zoom ,}"

# Status right look and feel
set -g status-right-length 100
set -g status-right ""
set -ga status-right "#[bg=default,bold]#{?#{e|>:#{battery_percentage},20},#[fg=#{@thm_green}] 󱐋 #{battery_percentage}%%%% ,#[bg=#{@thm_red},fg=default] 󱐋 #{battery_percentage}%%%% }"
set -ga status-right "#[bg=default,fg=#{@thm_overlay0},none,bold]│"
set -ga status-right "#[bg=default]#{?#{==:#{online_status},ok},#[fg=#{@thm_lavender}] 󰖩 on ,#[bg=#{@thm_red},fg=default,bold] 󰖪 off }"
set -ga status-right "#[bg=default,fg=#{@thm_overlay0},none,bold]│"
set -ga status-right "#[bg=default,fg=#{@thm_teal},bold] 󰭦 %Y-%m-%d 󰅐 %H:%M "

# Window content
# Change to "names" if you prefer to see window names
set -g @window_mode "icons"
# Rename a window to "!window" (without quotes) to use the current command as its name again
set -g window-status-format ' #I #{?#{==:#{@window_mode},icons},\
#("$XDG_CONFIG_HOME/tmux/scripts/icons.sh" "#{pane_current_command}"),\
#("$XDG_CONFIG_HOME/tmux/scripts/icons.sh" "#{pane_current_command}") #{?#{==:#W,!window},#{pane_current_command},#W}} '
set -g window-status-current-format ' #I #{?#{==:#{@window_mode},icons},\
#("$XDG_CONFIG_HOME/tmux/scripts/icons.sh" "#{pane_current_command}"),\
#("$XDG_CONFIG_HOME/tmux/scripts/icons.sh" "#{pane_current_command}") #{?#{==:#W,!window},#{pane_current_command},#W}} '

# Choose which window status separator to use
# (no separator for icons mode or separator for names mode)
set -gF window-status-separator ""
# set -gF window-status-separator "#[bg=default,fg=#{@thm_overlay0}]│"

# Window style
set -g window-status-style "bg=default,fg=#{@thm_mauve}"
set -g window-status-last-style "bg=default,fg=#{@thm_lavender}"
set -g window-status-current-style "bg=default,fg=#{@thm_blue},bold"
set -g window-status-activity-style "bg=default,fg=#{@thm_yellow},bold"
set -g window-status-bell-style "bg=default,fg=#{@thm_red},bold"

# Other status bar options
set -g status-position top
set -g status-bg default
set -g status-style "bg=default"
set -g status-justify absolute-centre

# Initialize TMUX plugin manager (this goes at the end of the status bar config)
run "$XDG_DATA_HOME/tmux/plugins/tpm/tpm"

# ========================================
# GENERAL OPTIONS
# ========================================

# Terminal settings
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

# Window settings
set -g base-index 1
set -g renumber-windows on

# Vim-like keybindings
setw -g mode-keys vi

# Monitor activity in panes
setw -g monitor-activity on

# Don't exit from tmux when closing the session
set -g detach-on-destroy off

# Remove delay for exiting insert mode with ESC in Neovim
set -sg escape-time 10

# Status bar position
set -g status-position top

# Neovim image rendering support
set -gq allow-passthrough on
set -g visual-activity off

# Enable support for focus events in applications like Neovim
set -g focus-events on

# Refresh the status every second
set -g status-interval 1

# Custom styles
set -g mode-style 'fg=#CBE0F0,bg=#033259'
set -g message-style 'bg=default'
set -g message-command-style 'bg=#292E42'
set -g pane-active-border-style 'fg=cyan'

# ========================================
# HOOKS
# ========================================

# Track last active pane and window globally
set-hook -g pane-focus-out \
  'run-shell "tmux set -s @last_active_pane \\%$(tmux display-message -p \"#{pane_id}\"); \
              tmux set -s @last_active_window $(tmux display-message -p \"#{window_id}\")"'

# ========================================
# KEYBINDINGS
# ========================================

# Enable mouse support and disable middle click
set -g mouse on
unbind -n MouseDown2Pane

# Prefix key
unbind-key -T root M-a
set -g prefix M-a
unbind-key C-b
bind-key M-a send-prefix

# Vertical split
unbind-key %
bind-key "\\" split-window -h -c "#{pane_current_path}"

# Horizontal split
unbind-key '"'
bind-key - split-window -v -c "#{pane_current_path}"

# Open new window in current directory
unbind-key c
bind-key c new-window -c "#{pane_current_path}"

# Reload tmux config
unbind-key r
bind-key r source-file "$XDG_CONFIG_HOME/tmux/tmux.conf"

# Resize panes
bind-key -r h resize-pane -L 3
bind-key -r j resize-pane -D 3
bind-key -r k resize-pane -U 3
bind-key -r l resize-pane -R 3

# Maximize the pane
bind-key m resize-pane -Z

# Go to last active pane
bind-key -n 'C-\' if -F "#{@pane-is-vim}" 'send-keys C-\\' 'select-pane -l'

# Start selecting text with "v"
bind-key -T copy-mode-vi 'v' send -X begin-selection
# Copy text with "y"
bind-key -T copy-mode-vi 'y' send -X copy-selection

# Moving windows
bind-key -n S-Left swap-window -d -t -1
bind-key -n S-Right swap-window -d -t +1

# Don't exit copy mode when dragging with mouse
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# Skip kill-pane confirmation
unbind-key x
bind-key x kill-pane

# Session switcher
bind-key " " display-popup -S "fg=#24EAF7" -T " Sessions " -b "rounded" -E "ICON=\$(printf '\033[34m\033[0m'); \
tmux list-sessions | sed -E 's/:.*\$//' \
| grep -v \"^\$(tmux display-message -p '#S')\$\" \
| sed \"s/^/\$ICON /\" \
| fzf --ansi --reverse --color 'fg:#CBE0F0,bg:-1,hl:#B388FF,fg+:#CBE0F0,bg+:#143652,hl+:#B388FF,info:#06BCE4,border:#2CF9ED,pointer:#2CF9ED,marker:#2CF9ED,spinner:#2CF9ED,header:#2CF9ED' --prompt '⚡' \
| sed 's/.* //' \
| xargs tmux switch-client -t"

# Popup terminal
unbind-key o
bind-key o display-popup \
  -S "fg=#24EAF7" \
  -b "rounded" \
  -d "#{pane_current_path}" \
  -w 75% \
  -h 75% \
  -E "zsh"

# Toggle window status between icons and names
unbind-key i
bind-key i run-shell '
  if [ "$(tmux show-option -gv @window_mode)" = "icons" ]; then
    tmux set -gF window-status-separator "#[bg=default,fg=#{@thm_overlay0}]│"
    tmux set -g @window_mode "names"
  else
    tmux set -gF window-status-separator ""
    tmux set -g @window_mode "icons"
  fi
  tmux refresh-client -S
'

# Toggle between notes session and last session
bind-key -n C-S-n run-shell '
  NOTES_DIR="$HOME/Notes"
  NOTES_FILE="notes.md"
  NOTES_SESSION="notes"

  [ ! -d "$NOTES_DIR" ] && mkdir -p "$NOTES_DIR"
  [ ! -f "$NOTES_DIR/$NOTES_FILE" ] && touch "$NOTES_FILE"

  # Create notes session if it does not exist
  if ! tmux has-session -t notes 2>/dev/null; then
    tmux new-session -d -s "$NOTES_SESSION" -c "$NOTES_DIR" "nvim $NOTES_FILE"
  fi

  # If we are in the notes session, switch to last session
  if [ "$(tmux display-message -p '#S')" = "$NOTES_SESSION" ]; then
    LAST_SESSION="$(tmux display-message -p '#\{client_last_session\}')"
    # Check if last session exists before switching
    if [ -n "$LAST_SESSION" ] && tmux has-session -t "$LAST_SESSION" 2>/dev/null; then
      tmux switch-client -t "$LAST_SESSION"
    fi
  # Switch to notes session if we are in another session
  else
    tmux switch-client -t "$NOTES_SESSION"
  fi
'
